<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Newsletter Subscribers</title>
		<!-- Tailwind CSS CDN -->
		<script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
		<style>
			body {
				font-family: "Inter", sans-serif;
			}
		</style>
	</head>
	<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
		<div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl">
			<h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
				Newsletter Subscribers
			</h1>

			<!-- Loading Indicator -->
			<div id="loadingIndicator" class="text-center text-gray-600 mb-4 hidden">
				<svg
					class="animate-spin h-5 w-5 mr-3 inline-block text-blue-500"
					viewBox="0 0 24 24"
				>
					<circle
						class="opacity-25"
						cx="12"
						cy="12"
						r="10"
						stroke="currentColor"
						stroke-width="4"
					></circle>
					<path
						class="opacity-75"
						fill="currentColor"
						d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
					></path>
				</svg>
				Loading emails...
			</div>

			<!-- Error Message -->
			<div
				id="errorMessage"
				class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 hidden"
				role="alert"
			>
				<strong class="font-bold">Error!</strong>
				<span class="block sm:inline" id="errorText"></span>
			</div>

			<!-- Email List Container -->
			<div id="emailListContainer" class="space-y-3">
				<!-- Emails will be dynamically inserted here -->
			</div>

			<div class="text-center mt-6">
				<button
					id="refreshButton"
					class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out shadow-md"
				>
					Refresh Emails
				</button>
			</div>
		</div>

		<script>
			document.addEventListener("DOMContentLoaded", () => {
				// Define your API endpoint URL
				// IMPORTANT: Replace this with the actual URL to your backend endpoint
				// that serves the list of newsletter subscribers.
				// Example: '[https://your-backend-api.onrender.com/api/newsletter/subscribers](https://your-backend-api.onrender.com/api/newsletter/subscribers)'
				const API_ENDPOINT =
					"https://amy-s-blog-backend.onrender.com/api/newsletter/getMailAddresses"; // Placeholder, replace with your actual endpoint

				const emailListContainer =
					document.getElementById("emailListContainer");
				const loadingIndicator = document.getElementById("loadingIndicator");
				const errorMessage = document.getElementById("errorMessage");
				const errorText = document.getElementById("errorText");
				const refreshButton = document.getElementById("refreshButton");

				/**
				 * Displays an error message on the page.
				 * @param {string} message - The error message to display.
				 */
				const displayError = (message) => {
					errorText.textContent = message;
					errorMessage.classList.remove("hidden");
				};

				/**
				 * Hides the error message.
				 */
				const hideError = () => {
					errorMessage.classList.add("hidden");
					errorText.textContent = "";
				};

				/**
				 * Fetches and displays the list of emails from the API.
				 */
				const fetchEmails = async () => {
					emailListContainer.innerHTML = ""; // Clear previous emails
					loadingIndicator.classList.remove("hidden"); // Show loading indicator
					hideError(); // Hide any previous errors

					try {
						// Retrieve JWT token from localStorage
						const token = localStorage.getItem("token");

						// Prepare headers, including Authorization if token exists
						const headers = {
							"Content-Type": "application/json",
						};

						headers["Authorization"] = `Bearer ${token}`;
						const response = await fetch(API_ENDPOINT, {
							method: "GET", // Or the appropriate method for your API
							headers: headers,
						});

						if (!response.ok) {
							// Handle HTTP errors (e.g., 404, 500)
							const errorData = await response
								.json()
								.catch(() => ({ message: "Unknown error" }));
							throw new Error(
								`HTTP error! Status: ${response.status}, Message: ${
									errorData.msg || errorData.message || "Server error"
								}`
							);
						}

						const emails = await response.json();

						if (!Array.isArray(emails)) {
							throw new Error("API did not return an array of emails.");
						}

						if (emails.length === 0) {
							emailListContainer.innerHTML =
								'<p class="text-gray-600 text-center py-4">No subscribers found yet.</p>';
						} else {
							emails.forEach((emailData) => {
								const emailDiv = document.createElement("div");
								emailDiv.className =
									"bg-gray-50 p-3 rounded-md border border-gray-200 flex flex-col sm:flex-row sm:justify-between sm:items-center";
								emailDiv.innerHTML = `
                                <span class="font-medium text-gray-900 break-all">${
																	emailData.email
																}</span>
                                <span class="text-sm text-gray-500 mt-1 sm:mt-0">Subscribed: ${new Date(
																	emailData.subscribed_at
																).toLocaleDateString()}</span>
                            `;
								emailListContainer.appendChild(emailDiv);
							});
						}
					} catch (error) {
						console.error("Error fetching emails:", error);
						displayError(`Failed to load emails: ${error.message}`);
					} finally {
						loadingIndicator.classList.add("hidden"); // Hide loading indicator
					}
				};

				// Initial fetch when the page loads
				fetchEmails();

				// Add event listener to the refresh button
				refreshButton.addEventListener("click", fetchEmails);
			});
		</script>
	</body>
</html>
